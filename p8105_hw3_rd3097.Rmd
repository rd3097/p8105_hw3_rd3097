---
title: "p8105_hw3_rd3097"
author: "RUOYING DENG"
date: "2023-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Necessary Library
```{r}
library(p8105.datasets)
#install.packages('cowplot')
library(tidyverse)
library(cowplot)
#install.packages("gridExtra")
library(gridExtra)
```


```{r}

data("instacart")

# 1）
instacart %>%
  count(aisle) %>%
  arrange(desc(n))

#There are   
# 2)
df_Q1_2 <- instacart %>%
  count(aisle) %>%
  filter(n > 10000) %>%
  arrange(desc(n))

ggplot(data = df_Q1_2, aes(x = aisle, y= n, group = 1)) +
  geom_line()+
  geom_point()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# 3)

instacart %>%
  filter(aisle %in% c('baking ingredients', 'dog food care', 'packaged vegetables fruits')) %>%
  group_by(aisle) %>%
  count(product_name, sort = TRUE) %>%
  top_n(3)
# To ensure the dataset has distinct product name for each order on rows level 
instacart %>%
  group_by(order_id) %>%
  count(product_name) %>%
  ungroup(order_id) %>%
  arrange(desc(n))
  

# 4)
# dow 0-6; hourly 0-23; productName = coffee ice cream, pink....
instacart %>%
  filter(product_name %in% c('Coffee Ice Cream', 'Pink Lady Apples')) %>%
  group_by(product_name,order_dow) %>%
  summarize(Mean = mean(order_hour_of_day, na.rm = TRUE)) %>%
  pivot_wider(names_from = order_dow, values_from = Mean)

```




## Problem 2

```{r}
data("brfss_smart2010")

# Focus Overall Health only

df_Q2 <- brfss_smart2010 %>%
  filter(Topic == 'Overall Health')%>%
  group_by(Response) %>%
  mutate(Response = factor(Response, levels = c('Poor', 'Fair', 'Good', 'Very good', 'Excellent'))) %>%
  ungroup(Response)

# 1)
head(df_Q2) # Locationabbr: states

# 2002 How many states .....
df_Q2 %>%
  filter(Year == 2002) %>%
  group_by(Locationabbr) %>%
  summarize(locationDistinctCount = n_distinct(Locationdesc)) %>%
  filter(locationDistinctCount >=7)

# 2010
df_Q2 %>%
  filter(Year == 2010) %>%
  group_by(Locationabbr) %>%
  summarize(locationDistinctCount = n_distinct(Locationdesc)) %>%
  filter(locationDistinctCount >=7)

# Construct a dataset that is limited to Excellent responses, and contains, year, state, and a variable that averages the data_value across locations within a state. Make a “spaghetti” plot of this average value over time within a state (that is, make a plot showing a line for each state across years – the geom_line geometry and group aesthetic will help)

df_Q2_lineplot <- df_Q2 %>%
  filter(Response == 'Excellent') %>%
  select(Year, Locationabbr, Data_value) %>%
  group_by(Year, Locationabbr) %>%
  summarize(Data_value = mean(Data_value, na.rm = TRUE)) %>%
  ungroup(Year, Locationabbr)

ggplot(data = df_Q2_lineplot, aes(x = Year, y = Data_value)) +
  geom_line(aes(color = Locationabbr))



# Make a two-panel plot showing, for the years 2006, and 2010, distribution of data_value for responses (“Poor” to “Excellent”) among locations in NY State.

df_Q2_2006 <- df_Q2 %>%
  filter(Locationabbr == 'NY' & Year == 2006)

df_Q2_2010 <- df_Q2 %>%
  filter(Locationabbr == 'NY' & Year == 2010) 

Q2Plot1 <- ggplot(df_Q2_2006, aes(x = Response, y = Data_value)) +
  geom_bar(stat = 'summary', fun = 'mean') +
  labs(title = "2006 Distribution of data_value for response")
Q2Plot2 <- ggplot(df_Q2_2010, aes(x = Response, y = Data_value)) +
  geom_bar(stat = 'summary', fun = 'mean') +
  labs(title = "2010 Distribution of data_value for response")


plot_grid(Q2Plot1, Q2Plot2, align = "v", ncol = 1, rel_heights = c(.5, .5))



```

## Problem 3
```{r}
#include all originally observed variables
covar <- read.csv("nhanes_covar.csv",skip =4)
accel <-read.csv("nhanes_accel.csv")
tidied_covar <- covar %>%
  #exclude participants less than 21 years of age
  filter(age >= 21)%>%
  #exclude those with missing demographic data
  drop_na(BMI, education)%>%
  #encode data with reasonable variable classes in factor instead of numerical
  mutate(sex = factor(recode(sex, "1" = "male", "2" = "female"), levels =c("male", "female")),
         education = factor(recode(education, "1"="Less than high school", "2" = "High school equivalent", "3" = "More than high school"),levels = c("Less than high school","High school equivalent", "More than high school")))

```
```{r}
#Produce a reader-friendly table for the number of men and women in each education category, since education is factor, we need to transfer the factor to numeric first for counting
problem3_2 <- transform(tidied_covar, education = as.numeric(education)) %>%
  group_by(sex,education)%>%
  summarise(number_of_people = sum(education))%>%
#then for a reader-friendly table, we need to tranfer the variable in education column back to character
  mutate(education = recode(education, "1"="Less than high school", "2" = "High school equivalent", "3" = "More than high school"))%>%
  ungroup(sex, education)
```

comment on the table: most of women and men's education are both more than high school.

```{r}
#create a visualization of the age distributions for men and women in each education category

#max age is 80
age_distribution<-tidied_covar%>%
  # Define age distribution groups
  mutate(age_groups = cut(age, breaks = c(20, 40, 60, 80),labels = c("20-40", "41-60", "61-80")))
 
#First we make plot for education less than high school
Less_high <- age_distribution %>%
  filter(education == "Less than high school")

age_group_counts1 <- Less_high %>%
  group_by(age_groups,sex) %>%
  summarise(count = n(), .groups = 'drop')  
#Second we make plot for education level High school equivalent
Equi_high <- age_distribution %>%
  filter(education == "High school equivalent")

age_group_counts2 <- Equi_high %>%
  group_by(age_groups,sex) %>%
  summarise(count = n(), .groups = 'drop')
#Third we make plot for education level More than high school 
More_high <- age_distribution%>%
  filter(education == "More than high school")


age_group_counts3 <- age_distribution %>%
  group_by(age_groups,sex) %>%
  summarise(count = n(), .groups = 'drop')

#Then we make plot for each education level
plot1<- ggplot(age_group_counts1, aes(x = age_groups, y = count, fill = sex)) +
  geom_bar(stat = "identity") +
  labs(x = "Age Group") +
  ggtitle("Age Distribution for Less than high school") +
  theme_minimal()
print(plot1)

plot2<- ggplot(age_group_counts2, aes(x = age_groups, y = count, fill = sex)) +
  geom_bar(stat = "identity") +
  labs(x = "Age Group") +
  ggtitle("Age Distribution for High school equivalent") +
  theme_minimal()

plot3<- ggplot(age_group_counts3, aes(x = age_groups, y = count, fill = sex)) +
  geom_bar(stat = "identity") +
  labs(x = "Age Group") +
  ggtitle("Age Distribution for More than high school ") +
  theme_minimal()

plot_grid(plot1, plot2, plot3, align = "v", ncol = 1, rel_heights = c(.5, .5))
```
comment: except for age group 20-40 and 41-60 of high school equivalent, where number of female are much less than the number of male, all other age groups in different education number has almost same number of female and male.

#Using tidied dataset, aggregate across minutes to create a total activity variable for each participant
```{r}
tidied_accel <- accel%>%
  mutate(total_activity = rowSums(accel[,-1]))%>%
  select(SEQN,total_activity,everything())

clean_data = 
  left_join(tidied_covar,tidied_accel, by = "SEQN")

#Plot these total activities (y-axis) against age (x-axis),plot should compare men to women and have separate panels for each education level, Include a trend line

#First for education level less than high school
clean_data_less<- filter(clean_data, education == "Less than high school" )
total_activities_plot_1= 
  clean_data_less |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  ggtitle("Total Activity Distribution for Less than High School") +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE)

#Second for education level equivalent to high schhol
clean_data_equi<- filter(clean_data, education == "High school equivalent" )
total_activities_plot_2= 
  clean_data_equi |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  ggtitle("Total Activity Distribution for High school equivalent") +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE)

#Third for education level higher than high school
clean_data_equi<- filter(clean_data, education == "More than high school" ) 
total_activities_plot_3= 
  clean_data_equi |> 
  ggplot(aes(x = age, y = total_activity, color = sex)) + 
  ggtitle("Total Activity Distribution for More than High school") +
  geom_point(alpha = .5) +
  geom_smooth(se = FALSE)

plot_grid(total_activities_plot_1, total_activities_plot_2, total_activities_plot_3, align = "v", ncol = 1, rel_heights = c(.5, .5))
```
These trendline illustrates that for education level less than high school, male and female has almost the same total activity except that male has a bit larger total activity time for age over 50.

For education level equivalent to high school, female has larger total activity distribution than male except for age around 63 where female has almost same total activity time as male.

For education level higher than high school, female has a bit larger total activity time than male except for age 47 where female has almost same total activity time as male.

```{r}
#Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. 

long_clean_data <- clean_data_less %>%
  pivot_longer(cols = c(min1: min1440), names_to = "Time", values_to = "Value")

#combine rows based on the time interval an hour
Time_long <- long_clean_data %>%
  mutate(Hour = (as.numeric(sub("min", "", Time)) - 1) %/% 60 + 1)

Time_summary <- Time_long %>%
  group_by(Hour) %>%
  mutate(Hour_Value = mean(Value))

#First for data with education level less than high school

  
ggplot(Time_summary, aes(x = Hour, y = Hour_Value)) +
  geom_bar(stat = "identity") +
  labs(x = "Hour", y = "Activity Values") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  coord_flip()  # Rotate the x-axis labels if needed



```

